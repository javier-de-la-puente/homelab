---
- name: Check if Cilium CLI is installed
  ansible.builtin.stat:
    path: /usr/local/bin/cilium
  register: cilium_cli

- name: Download Cilium CLI tarball
  ansible.builtin.get_url:
    url: https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
    dest: /tmp/cilium-linux-amd64.tar.gz
    mode: '0644'
  when: not cilium_cli.stat.exists

- name: Extract Cilium CLI
  ansible.builtin.unarchive:
    src: /tmp/cilium-linux-amd64.tar.gz
    dest: /tmp
    remote_src: true
  when: not cilium_cli.stat.exists

- name: Install Cilium CLI binary
  ansible.builtin.copy:
    src: /tmp/cilium
    dest: /usr/local/bin/cilium
    mode: '0755'
    remote_src: true
  when: not cilium_cli.stat.exists

- name: Clean up Cilium CLI temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/cilium-linux-amd64.tar.gz
    - /tmp/cilium
  when: not cilium_cli.stat.exists

- name: Check if Cilium is installed in cluster
  ansible.builtin.command: cilium status --output json
  register: cilium_status
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Install Cilium CNI
  ansible.builtin.command:
    cmd: >
      cilium install
      --set kubeProxyReplacement=true
      --set k8sServiceHost={{ ansible_host }}
      --set k8sServicePort=6443
  when: cilium_status.rc != 0
  changed_when: true
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: Wait for Cilium to be ready
  ansible.builtin.command: cilium status --wait
  changed_when: false
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
