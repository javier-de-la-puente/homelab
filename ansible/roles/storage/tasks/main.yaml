---
# OS-level disk configuration only
# Longhorn configuration is handled by add-storage.yaml playbook

- name: Check if disk is already mounted by label
  ansible.builtin.shell: |
    findmnt -n -o SOURCE --target {{ item.mount_path }} 2>/dev/null || echo "not_mounted"
  loop: "{{ storage_disks }}"
  register: mount_check
  changed_when: false
  when: storage_disks is defined and storage_disks | length > 0

- name: Check current filesystem type (only for unmounted disks)
  ansible.builtin.command: blkid -o value -s TYPE {{ item.item.device }}
  loop: "{{ mount_check.results }}"
  register: current_fs
  changed_when: false
  failed_when: false
  when:
    - storage_disks is defined and storage_disks | length > 0
    - item.stdout == "not_mounted"

- name: Format storage disks (only if not already mounted)
  community.general.filesystem:
    dev: "{{ item.item.item.device }}"
    fstype: "{{ item.item.item.fstype | default('ext4') }}"
    opts: "-L {{ item.item.item.label }}"
    force: "{{ item.item.item.force | default(false) }}"
  loop: "{{ current_fs.results | default([]) }}"
  when:
    - storage_disks is defined and storage_disks | length > 0
    - item.skipped is not defined or not item.skipped
    - item.stdout is defined
    - item.stdout != (item.item.item.fstype | default('ext4'))

- name: Create mount points
  ansible.builtin.file:
    path: "{{ item.mount_path }}"
    state: directory
    mode: '0755'
  loop: "{{ storage_disks }}"
  when: storage_disks is defined and storage_disks | length > 0

- name: Mount storage disks
  ansible.posix.mount:
    path: "{{ item.mount_path }}"
    src: "LABEL={{ item.label }}"
    fstype: "{{ item.fstype | default('ext4') }}"
    opts: defaults
    state: mounted
  loop: "{{ storage_disks }}"
  when: storage_disks is defined and storage_disks | length > 0
